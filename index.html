<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="SL Avgångar" />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%231A1A2E' width='180' height='180'/><circle cx='90' cy='60' r='25' fill='%23FF6B35'/><rect x='65' y='90' width='50' height='60' rx='8' fill='%23F7931E'/><rect x='70' y='100' width='18' height='18' fill='%231A1A2E'/><rect x='92' y='100' width='18' height='18' fill='%231A1A2E'/><rect x='70' y='125' width='18' height='18' fill='%231A1A2E'/><rect x='92' y='125' width='18' height='18' fill='%231A1A2E'/></svg>"
    />
    <title>SL Board</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="stations-grid" id="stationsGrid"></div>
    </div>

    <script>
      // ==================== CONFIGURATION ====================

      var CONFIG = {
        stations: [
          {
            name: "Flottbrovägen → City",
            siteId: 1285,
            containerId: "departuresContainerDeparturesBus",
            filters: {
              transportMode: "BUS",
              excludeDestination: "stora essingen",
            },
            limit: 5,
            urgentThreshold: 1,
          },
          {
            name: "City → Flottbrovägen",
            siteId: 1285,
            containerId: "departuresContainerArrivalsBus",
            filters: {
              transportMode: "BUS",
              excludeDestination: "frihamnen",
            },
            limit: 2,
          },
          {
            name: "Solna",
            siteId: 9811,
            containerId: "departuresContainerSickla",
            filters: {
              transportMode: "TRAM",
              excludeDestination: "Sickla",
            },
            limit: 3,
            urgentThreshold: 5,
          },
          {
            name: "Sickla",
            siteId: 9811,
            containerId: "departuresContainerNacka",
            filters: {
              transportMode: "TRAM",
              excludeDestination: "Solna station",
            },
            limit: 3,
            urgentThreshold: 5,
          },
        ],

        display: {
          autoRefreshIntervalMs: 30000,
        },
      };

      // ==================== END CONFIGURATION ====================

      var autoRefreshInterval;

      // ==================== UTILITY FUNCTIONS ====================

      function parseISODate(isoString) {
        // Manual parsing for iOS 9.3.5 compatibility
        // Expected format: 2025-01-08T10:30:00+01:00 or 2025-01-08T10:30:00Z
        var parts = isoString.match(
          /(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/
        );
        if (!parts) return new Date(isoString);

        var year = parseInt(parts[1], 10);
        var month = parseInt(parts[2], 10) - 1;
        var day = parseInt(parts[3], 10);
        var hour = parseInt(parts[4], 10);
        var minute = parseInt(parts[5], 10);
        var second = parseInt(parts[6], 10);

        // Check for timezone offset
        var tzMatch = isoString.match(/([+-])(\d{2}):(\d{2})$/);
        if (tzMatch) {
          var tzSign = tzMatch[1] === "+" ? -1 : 1;
          var tzHours = parseInt(tzMatch[2], 10);
          var tzMinutes = parseInt(tzMatch[3], 10);
          var tzOffset = tzSign * (tzHours * 60 + tzMinutes);

          var date = new Date(year, month, day, hour, minute, second);
          var localOffset = date.getTimezoneOffset();
          date.setMinutes(date.getMinutes() + tzOffset + localOffset);
          return date;
        }

        return new Date(year, month, day, hour, minute, second);
      }

      function formatTimeDisplay(expectedTime) {
        var now = new Date();
        var diffMinutes = Math.round((expectedTime - now) / 60000);
        var hours = expectedTime.getHours();
        var minutes = expectedTime.getMinutes();
        var clockTime =
          (hours < 10 ? "0" : "") +
          hours +
          ":" +
          (minutes < 10 ? "0" : "") +
          minutes;

        if (diffMinutes <= 0) {
          return (
            '<div class="time-clock">' +
            clockTime +
            '</div><div class="time-minutes">NU</div>'
          );
        } else {
          return (
            '<div class="time-clock">' +
            clockTime +
            '</div><div class="time-minutes">' +
            diffMinutes +
            " min</div>"
          );
        }
      }

      function calculateDelay(expectedTime, scheduledTime) {
        return Math.round((expectedTime - scheduledTime) / 60000);
      }

      function buildDepartureInfo(departure) {
        var infoItems = [];

        if (departure.via) {
          infoItems.push('<span class="via">via ' + departure.via + "</span>");
        }

        var expectedTime = parseISODate(departure.expected);
        var scheduledTime = parseISODate(departure.scheduled);
        var delayMinutes = calculateDelay(expectedTime, scheduledTime);

        if (delayMinutes > 0) {
          infoItems.push(
            '<span class="deviation">Försenad ' + delayMinutes + " min</span>"
          );
        } else if (delayMinutes < 0) {
          infoItems.push(
            "<span>Tidig " + Math.abs(delayMinutes) + " min</span>"
          );
        }

        if (
          departure.deviations &&
          typeof departure.deviations === "string" &&
          departure.deviations.trim()
        ) {
          infoItems.push(
            '<span class="deviation">' + departure.deviations + "</span>"
          );
        }

        if (departure.journey && departure.journey.state) {
          var stateMessages = {
            CANCELLED: "Inställd",
            REPLACEMENT: "Ersättningstrafik",
          };
          if (stateMessages[departure.journey.state]) {
            infoItems.push(
              '<span class="deviation">' +
                stateMessages[departure.journey.state] +
                "</span>"
            );
          }
        }

        return {
          html: infoItems.length > 0 ? infoItems.join(" • ") : "",
          hasDelay: delayMinutes > 0,
        };
      }

      function renderDepartureItem(departure, station) {
        var expectedTime = parseISODate(departure.expected);
        var now = new Date();
        var diffMinutes = Math.round((expectedTime - now) / 60000);

        var timeDisplay = formatTimeDisplay(expectedTime);
        var info = buildDepartureInfo(departure);

        var isUrgent =
          station.urgentThreshold !== undefined &&
          diffMinutes <= station.urgentThreshold;

        var infoHTML = info.html
          ? '<div class="departure-info' +
            (info.hasDelay ? " has-delay" : "") +
            '">' +
            info.html +
            "</div>"
          : "";

        return (
          '<div class="departure-item' +
          (isUrgent ? " urgent" : "") +
          ' fade-in">' +
          '<div class="departure-item-main">' +
          '<div class="line-number">' +
          departure.line.designation +
          "</div>" +
          '<div class="destination">' +
          departure.destination +
          "</div>" +
          timeDisplay +
          "</div>" +
          (infoHTML ? "\n          " + infoHTML : "") +
          "</div>"
        );
      }

      // ==================== END UTILITY FUNCTIONS ====================

      // ==================== INITIALIZATION ====================

      function initializeStations() {
        var grid = document.getElementById("stationsGrid");
        var html = "";

        for (var i = 0; i < CONFIG.stations.length; i++) {
          var station = CONFIG.stations[i];
          html +=
            '<div class="station-module">' +
            '<h1 class="station-name">' +
            station.name +
            "</h1>" +
            '<div class="departures-container" id="' +
            station.containerId +
            '">' +
            '<div class="loading">Hämtar avgångar</div>' +
            "</div>" +
            "</div>";
        }

        html +=
          '<button class="refresh-btn" id="refreshBtn" onclick="fetchDepartures()">Uppdatera</button>';

        grid.innerHTML = html;
      }

      initializeStations();

      // ==================== END INITIALIZATION ====================

      var countdownInterval;
      var secondsUntilRefresh = 0;

      function updateButtonCountdown() {
        var btn = document.getElementById("refreshBtn");
        if (secondsUntilRefresh > 0) {
          btn.innerHTML =
            'Nästa uppdatering om <span class="countdown-timer">' +
            secondsUntilRefresh +
            "</span>s";
          secondsUntilRefresh--;
        } else {
          btn.textContent = "Uppdaterar...";
        }
      }

      function startCountdown() {
        secondsUntilRefresh = CONFIG.display.autoRefreshIntervalMs / 1000;

        if (countdownInterval) {
          clearInterval(countdownInterval);
        }

        updateButtonCountdown();
        countdownInterval = setInterval(updateButtonCountdown, 1000);
      }

      function fetchStationDepartures(station, callback) {
        var container = document.getElementById(station.containerId);

        var xhr = new XMLHttpRequest();
        xhr.open(
          "GET",
          "https://transport.integration.sl.se/v1/sites/" +
            station.siteId +
            "/departures",
          true
        );

        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status === 200) {
              try {
                var data = JSON.parse(xhr.responseText);
                var filteredDepartures = data.departures;

                if (station.filters.lineNumber) {
                  var temp = [];
                  for (var i = 0; i < filteredDepartures.length; i++) {
                    if (
                      filteredDepartures[i].line.designation ===
                      station.filters.lineNumber
                    ) {
                      temp.push(filteredDepartures[i]);
                    }
                  }
                  filteredDepartures = temp;
                }

                if (station.filters.transportMode) {
                  var temp = [];
                  for (var i = 0; i < filteredDepartures.length; i++) {
                    if (
                      filteredDepartures[i].line.transport_mode ===
                      station.filters.transportMode
                    ) {
                      temp.push(filteredDepartures[i]);
                    }
                  }
                  filteredDepartures = temp;
                }

                if (station.filters.excludeDestination) {
                  var temp = [];
                  for (var i = 0; i < filteredDepartures.length; i++) {
                    if (
                      filteredDepartures[i].destination
                        .toLowerCase()
                        .indexOf(
                          station.filters.excludeDestination.toLowerCase()
                        ) === -1
                    ) {
                      temp.push(filteredDepartures[i]);
                    }
                  }
                  filteredDepartures = temp;
                }

                filteredDepartures = filteredDepartures.slice(0, station.limit);

                if (filteredDepartures.length === 0) {
                  container.innerHTML =
                    '<div class="error">Inga avgångar hittades</div>';
                  if (callback) callback();
                  return;
                }

                var newHTML = "";
                for (var i = 0; i < filteredDepartures.length; i++) {
                  var html = renderDepartureItem(
                    filteredDepartures[i],
                    station
                  );
                  html = html.replace(
                    'class="departure-item fade-in"',
                    'class="departure-item fade-in" style="animation-delay: ' +
                      i * 0.1 +
                      's"'
                  );
                  newHTML += html;
                }

                var existingItems =
                  container.querySelectorAll(".departure-item");

                if (existingItems.length > 0) {
                  for (var i = 0; i < existingItems.length; i++) {
                    existingItems[i].classList.add("fade-out");
                  }
                  setTimeout(function () {
                    container.innerHTML = newHTML;
                    if (callback) callback();
                  }, 300);
                } else {
                  var isFirstLoad = !container.querySelector(".error");
                  if (isFirstLoad) {
                    container.innerHTML =
                      '<div class="loading">Hämtar avgångar</div>';
                    setTimeout(function () {
                      container.innerHTML = newHTML;
                      if (callback) callback();
                    }, 200);
                  } else {
                    container.innerHTML = newHTML;
                    if (callback) callback();
                  }
                }
              } catch (e) {
                container.innerHTML =
                  '<div class="error"><strong>Kunde inte hämta avgångar</strong><br>Parse error</div>';
                if (callback) callback();
              }
            } else {
              container.innerHTML =
                '<div class="error"><strong>Kunde inte hämta avgångar</strong><br>HTTP error: ' +
                xhr.status +
                "</div>";
              if (callback) callback();
            }
          }
        };

        xhr.send();
      }

      function fetchDepartures() {
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }

        var btn = document.getElementById("refreshBtn");
        btn.textContent = "Uppdaterar...";

        var completed = 0;
        var total = CONFIG.stations.length;

        function onStationComplete() {
          completed++;
          if (completed === total) {
            startCountdown();
          }
        }

        for (var i = 0; i < CONFIG.stations.length; i++) {
          fetchStationDepartures(CONFIG.stations[i], onStationComplete);
        }
      }

      fetchDepartures();

      autoRefreshInterval = setInterval(
        fetchDepartures,
        CONFIG.display.autoRefreshIntervalMs
      );

      window.addEventListener("beforeunload", function () {
        clearInterval(autoRefreshInterval);
      });
    </script>
  </body>
</html>
