<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="SL Avgångar" />
    <link
      rel="apple-touch-icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%231A1A2E' width='180' height='180'/><circle cx='90' cy='60' r='25' fill='%23FF6B35'/><rect x='65' y='90' width='50' height='60' rx='8' fill='%23F7931E'/><rect x='70' y='100' width='18' height='18' fill='%231A1A2E'/><rect x='92' y='100' width='18' height='18' fill='%231A1A2E'/><rect x='70' y='125' width='18' height='18' fill='%231A1A2E'/><rect x='92' y='125' width='18' height='18' fill='%231A1A2E'/></svg>"
    />
    <title>Buss 1 - Flottbrovägen | Tvärbanan - Stora Essingen</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <div class="stations-grid">
        <div class="station-module">
          <header>
            <h1 class="station-name">Flottbrovägen</h1>
          </header>

          <div class="departures-container" id="departuresContainer">
            <div class="loading">Hämtar avgångar</div>
          </div>
        </div>

        <div class="station-module">
          <header>
            <h1 class="station-name">Stora Essingen</h1>
          </header>

          <div class="departures-container" id="departuresContainerTvarbanan">
            <div class="loading">Hämtar avgångar</div>
          </div>
        </div>
      </div>

      <button class="refresh-btn" id="refreshBtn" onclick="fetchDepartures()">
        Uppdatera
      </button>
    </div>

    <script>
      // ==================== CONFIGURATION ====================

      const CONFIG = {
        stations: [
          {
            name: "Flottbrovägen",
            siteId: 1285,
            containerId: "departuresContainer",
            filters: {
              lineNumber: "1",
              transportMode: "BUS",
              excludeDestination: "stora essingen",
            },
            limit: 5,
            urgentThreshold: 1, // Show red alert when ≤ 1 minute away
          },
          {
            name: "Stora Essingen",
            siteId: 9811,
            containerId: "departuresContainerTvarbanan",
            filters: {
              transportMode: "TRAM",
            },
            limit: 5,
            urgentThreshold: 5, // Show red alert when ≤ 5 minutes away
          },
        ],

        display: {
          autoRefreshIntervalMs: 30000, // Auto-refresh every 30 seconds
        },
      };

      // ==================== END CONFIGURATION ====================

      let autoRefreshInterval;

      // ==================== UTILITY FUNCTIONS ====================

      function formatTimeDisplay(expectedTime) {
        const now = new Date();
        const diffMinutes = Math.round((expectedTime - now) / 60000);
        const clockTime = expectedTime.toLocaleTimeString("sv-SE", {
          hour: "2-digit",
          minute: "2-digit",
        });

        if (diffMinutes <= 0) {
          return `<div class="time-clock">${clockTime}</div><div class="time-minutes">NU</div>`;
        } else {
          return `<div class="time-clock">${clockTime}</div><div class="time-minutes">${diffMinutes} min</div>`;
        }
      }

      function calculateDelay(expectedTime, scheduledTime) {
        return Math.round((expectedTime - scheduledTime) / 60000);
      }

      function buildDepartureInfo(departure) {
        const infoItems = [];

        // Add via information if present
        if (departure.via) {
          infoItems.push(`<span class="via">via ${departure.via}</span>`);
        }

        // Add delay information
        const expectedTime = new Date(departure.expected);
        const scheduledTime = new Date(departure.scheduled);
        const delayMinutes = calculateDelay(expectedTime, scheduledTime);

        if (delayMinutes > 0) {
          infoItems.push(
            `<span class="deviation">Försenad ${delayMinutes} min</span>`
          );
        } else if (delayMinutes < 0) {
          infoItems.push(`<span>Tidig ${Math.abs(delayMinutes)} min</span>`);
        }

        // Add deviation/disruption information
        if (
          departure.deviations &&
          typeof departure.deviations === "string" &&
          departure.deviations.trim()
        ) {
          infoItems.push(
            `<span class="deviation">${departure.deviations}</span>`
          );
        }

        // Add journey state information
        if (departure.journey && departure.journey.state) {
          const stateMessages = {
            CANCELLED: "Inställd",
            REPLACEMENT: "Ersättningstrafik",
          };
          if (stateMessages[departure.journey.state]) {
            infoItems.push(
              `<span class="deviation">${
                stateMessages[departure.journey.state]
              }</span>`
            );
          }
        }

        return {
          html: infoItems.length > 0 ? infoItems.join(" • ") : "",
          hasDelay: delayMinutes > 0,
        };
      }

      function renderDepartureItem(departure, station) {
        const expectedTime = new Date(departure.expected);
        const now = new Date();
        const diffMinutes = Math.round((expectedTime - now) / 60000);

        const timeDisplay = formatTimeDisplay(expectedTime);
        const info = buildDepartureInfo(departure);

        // Determine if departure is urgent based on station's urgentThreshold
        const isUrgent =
          station.urgentThreshold !== undefined &&
          diffMinutes <= station.urgentThreshold;

        // Only render info div if there's content
        const infoHTML = info.html
          ? `<div class="departure-info${info.hasDelay ? " has-delay" : ""}">${
              info.html
            }</div>`
          : "";

        return `
        <div class="departure-item${isUrgent ? " urgent" : ""} fade-in">
          <div class="departure-item-main">
            <div class="line-number">${departure.line.designation}</div>
            <div class="destination">${departure.destination}</div>
            ${timeDisplay}
          </div>${infoHTML ? "\n          " + infoHTML : ""}
        </div>
      `;
      }

      // ==================== END UTILITY FUNCTIONS ====================

      let countdownInterval;
      let secondsUntilRefresh = 0;

      function updateButtonCountdown() {
        const btn = document.getElementById("refreshBtn");
        if (secondsUntilRefresh > 0) {
          btn.innerHTML = `Nästa uppdatering om <span class="countdown-timer">${secondsUntilRefresh}</span>s`;
          secondsUntilRefresh--;
        } else {
          btn.textContent = "Uppdaterar...";
        }
      }

      function startCountdown() {
        secondsUntilRefresh = CONFIG.display.autoRefreshIntervalMs / 1000;

        // Clear any existing countdown
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }

        // Update immediately
        updateButtonCountdown();

        // Then update every second
        countdownInterval = setInterval(updateButtonCountdown, 1000);
      }

      async function fetchStationDepartures(station) {
        const container = document.getElementById(station.containerId);

        try {
          const response = await fetch(
            `https://transport.integration.sl.se/v1/sites/${station.siteId}/departures`
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Filter departures based on station configuration
          let filteredDepartures = data.departures;

          if (station.filters.lineNumber) {
            filteredDepartures = filteredDepartures.filter(
              (dep) => dep.line.designation === station.filters.lineNumber
            );
          }

          if (station.filters.transportMode) {
            filteredDepartures = filteredDepartures.filter(
              (dep) => dep.line.transport_mode === station.filters.transportMode
            );
          }

          if (station.filters.excludeDestination) {
            filteredDepartures = filteredDepartures.filter(
              (dep) =>
                !dep.destination
                  .toLowerCase()
                  .includes(station.filters.excludeDestination.toLowerCase())
            );
          }

          filteredDepartures = filteredDepartures.slice(0, station.limit);

          if (filteredDepartures.length === 0) {
            container.innerHTML =
              '<div class="error">Inga avgångar hittades</div>';
            return;
          }

          // Generate HTML using utility function
          const newHTML = filteredDepartures
            .map((dep, index) => {
              const html = renderDepartureItem(dep, station);
              // Add inline style for staggered animation delay
              return html.replace(
                'class="departure-item fade-in"',
                `class="departure-item fade-in" style="animation-delay: ${
                  index * 0.1
                }s"`
              );
            })
            .join("");

          // Smooth transition: fade out old items, then fade in new ones
          const existingItems = container.querySelectorAll(".departure-item");

          if (existingItems.length > 0) {
            // Fade out existing items
            existingItems.forEach((item) => item.classList.add("fade-out"));

            // Wait for fade out to complete, then replace content
            await new Promise((resolve) => setTimeout(resolve, 300));
            container.innerHTML = newHTML;
          } else {
            // First load - show loading state briefly
            const isFirstLoad = !container.querySelector(".error");
            if (isFirstLoad) {
              container.innerHTML =
                '<div class="loading">Hämtar avgångar</div>';
              await new Promise((resolve) => setTimeout(resolve, 200));
            }
            container.innerHTML = newHTML;
          }
        } catch (error) {
          console.error(
            `Error fetching departures for ${station.name}:`,
            error
          );
          container.innerHTML = `
          <div class="error">
            <strong>Kunde inte hämta avgångar</strong><br>
            ${error.message}
          </div>
        `;
        }
      }

      async function fetchDepartures() {
        // Stop countdown while fetching
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }

        const btn = document.getElementById("refreshBtn");
        btn.textContent = "Uppdaterar...";

        // Fetch departures for all configured stations
        await Promise.all(
          CONFIG.stations.map((station) => fetchStationDepartures(station))
        );

        // Start countdown for next refresh
        startCountdown();
      }

      // Initial fetch
      fetchDepartures();

      // Auto-refresh
      autoRefreshInterval = setInterval(
        fetchDepartures,
        CONFIG.display.autoRefreshIntervalMs
      );

      // Clean up on page unload
      window.addEventListener("beforeunload", () => {
        clearInterval(autoRefreshInterval);
      });
    </script>
  </body>
</html>
